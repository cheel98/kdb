# é‚®ç®±éªŒè¯åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿæ–°å¢äº†é‚®ç®±éªŒè¯åŠŸèƒ½ï¼Œç”¨äºåœ¨gRPCæœåŠ¡ä¸­å®ç°åŸºäºé‚®ç®±çš„å¯¹è¯ä¿å­˜æœºåˆ¶ã€‚ç”¨æˆ·éœ€è¦å…ˆæä¾›æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼Œç³»ç»Ÿä¼šéªŒè¯é‚®ç®±æ ¼å¼å¹¶ç”Ÿæˆå”¯ä¸€çš„ç”¨æˆ·IDï¼Œåç»­çš„å¯¹è¯å°†æ ¹æ®é‚®ç®±è¿›è¡Œä¿å­˜å’Œç®¡ç†ã€‚

## ä¸»è¦ç‰¹æ€§

- âœ… **é‚®ç®±æ ¼å¼éªŒè¯**: è‡ªåŠ¨éªŒè¯é‚®ç®±åœ°å€çš„æœ‰æ•ˆæ€§
- ğŸ†” **ç”¨æˆ·IDç”Ÿæˆ**: åŸºäºé‚®ç®±ç”Ÿæˆå”¯ä¸€çš„ç”¨æˆ·æ ‡è¯†
- ğŸ’¾ **å¯¹è¯æŒä¹…åŒ–**: å°†å¯¹è¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­
- ğŸ”— **å¯¹è¯å…³è”**: åç»­å¯¹è¯è‡ªåŠ¨å…³è”åˆ°åŒä¸€ç”¨æˆ·
- ğŸ“ **å¯¹è¯ç®¡ç†**: æ”¯æŒåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤å¯¹è¯

## æ–°å¢çš„gRPCæ¥å£

### 1. VerifyEmail - é‚®ç®±éªŒè¯

**è¯·æ±‚æ¶ˆæ¯**: `EmailVerificationRequest`
```protobuf
message EmailVerificationRequest {
    string email = 1;  // é‚®ç®±åœ°å€
}
```

**å“åº”æ¶ˆæ¯**: `EmailVerificationResponse`
```protobuf
message EmailVerificationResponse {
    bool success = 1;        // è¯·æ±‚æ˜¯å¦æˆåŠŸ
    bool is_valid = 2;       // é‚®ç®±æ˜¯å¦æœ‰æ•ˆ
    string user_id = 3;      // ç”Ÿæˆçš„ç”¨æˆ·ID
    string error_message = 4; // é”™è¯¯ä¿¡æ¯
}
```

### 2. ChatWithEmailVerification - å¸¦é‚®ç®±éªŒè¯çš„èŠå¤©

**è¯·æ±‚æ¶ˆæ¯**: `EmailChatRequest`
```protobuf
message EmailChatRequest {
    string email = 1;                    // é‚®ç®±åœ°å€
    string question = 2;                 // ç”¨æˆ·é—®é¢˜
    string conversation_id = 3;          // å¯¹è¯ID (å¯é€‰)
    string conversation_title = 4;       // å¯¹è¯æ ‡é¢˜ (å¯é€‰)
    bool use_feedback = 5;               // æ˜¯å¦ä½¿ç”¨åé¦ˆ
    bool use_reranking = 6;              // æ˜¯å¦ä½¿ç”¨é‡æ’åº
    int32 top_k = 7;                     // æ£€ç´¢æ–‡æ¡£æ•°é‡
    float similarity_threshold = 8;       // ç›¸ä¼¼åº¦é˜ˆå€¼
    int32 max_history_turns = 9;         // æœ€å¤§å†å²è½®æ•°
}
```

**å“åº”æ¶ˆæ¯**: ä½¿ç”¨ç°æœ‰çš„ `ChatResponse`

## ä½¿ç”¨æ–¹æ³•

### 1. å‘½ä»¤è¡Œä½¿ç”¨

#### éªŒè¯é‚®ç®±
```bash
python src/rpc/grpc_client.py --verify-email test@example.com
```

#### å¸¦é‚®ç®±éªŒè¯çš„èŠå¤©
```bash
python src/rpc/grpc_client.py --email test@example.com --question "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ"
```

#### äº¤äº’å¼æ¼”ç¤º
```bash
python src/rpc/grpc_client.py --demo
```
åœ¨äº¤äº’å¼æ¼”ç¤ºä¸­ï¼Œé€‰æ‹©æ¨¡å¼2ï¼ˆé‚®ç®±éªŒè¯èŠå¤©ï¼‰æ¥ä½“éªŒå®Œæ•´åŠŸèƒ½ã€‚

### 2. Pythonä»£ç ä½¿ç”¨

```python
from rpc.grpc_client import KnowledgeServiceClient

# åˆ›å»ºå®¢æˆ·ç«¯
client = KnowledgeServiceClient()

# éªŒè¯é‚®ç®±
email_response = client.verify_email("test@example.com")
if email_response and email_response.is_valid:
    print(f"é‚®ç®±æœ‰æ•ˆï¼Œç”¨æˆ·ID: {email_response.user_id}")

# å¸¦é‚®ç®±éªŒè¯çš„èŠå¤©
response = client.chat_with_email(
    email="test@example.com",
    question="ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ",
    conversation_title="AIè®¨è®º"
)

if response and response.success:
    print(f"å›ç­”: {response.final_answer}")
    
    # è·å–å¯¹è¯IDç”¨äºåç»­å¯¹è¯
    if response.feedback_info and 'conversation_id' in response.feedback_info:
        conversation_id = response.feedback_info['conversation_id']
        
        # åç»­å¯¹è¯
        follow_up = client.chat_with_email(
            email="test@example.com",
            question="è¯·è¯¦ç»†è§£é‡Šä¸€ä¸‹",
            conversation_id=conversation_id
        )

client.close()
```

## å·¥ä½œæµç¨‹

1. **é‚®ç®±éªŒè¯é˜¶æ®µ**:
   - ç”¨æˆ·æä¾›é‚®ç®±åœ°å€
   - ç³»ç»ŸéªŒè¯é‚®ç®±æ ¼å¼ï¼ˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼‰
   - ç”ŸæˆåŸºäºé‚®ç®±çš„å”¯ä¸€ç”¨æˆ·IDï¼ˆä½¿ç”¨SHA-256å“ˆå¸Œï¼‰

2. **å¯¹è¯åˆ›å»ºé˜¶æ®µ**:
   - å¦‚æœæä¾›äº†å¯¹è¯IDï¼ŒéªŒè¯å¯¹è¯æ˜¯å¦å±äºè¯¥ç”¨æˆ·
   - å¦‚æœæ²¡æœ‰å¯¹è¯IDï¼Œåˆ›å»ºæ–°çš„å¯¹è¯
   - å°†ç”¨æˆ·IDå…³è”åˆ°å¯¹è¯

3. **å¯¹è¯ä¿å­˜é˜¶æ®µ**:
   - å°†ç”¨æˆ·é—®é¢˜å’ŒAIå›ç­”ä¿å­˜åˆ°æ•°æ®åº“
   - ç»´æŠ¤å¯¹è¯çš„ä¸Šä¸‹æ–‡å’Œå†å²è®°å½•
   - æ”¯æŒå¤šè½®å¯¹è¯çš„è¿ç»­æ€§

## æ•°æ®åº“å˜æ›´

å¯¹è¯è¡¨ï¼ˆConversationï¼‰ä¸­çš„ `user_id` å­—æ®µç°åœ¨ç”¨äºå­˜å‚¨åŸºäºé‚®ç®±ç”Ÿæˆçš„ç”¨æˆ·æ ‡è¯†ï¼Œç¡®ä¿æ¯ä¸ªé‚®ç®±å¯¹åº”å”¯ä¸€çš„ç”¨æˆ·IDã€‚

## æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š
```bash
python test_email_feature.py
```

æµ‹è¯•è„šæœ¬ä¼šéªŒè¯ï¼š
- é‚®ç®±æ ¼å¼éªŒè¯åŠŸèƒ½
- å¸¦é‚®ç®±éªŒè¯çš„èŠå¤©åŠŸèƒ½
- å¤šè½®å¯¹è¯çš„è¿ç»­æ€§

## æ³¨æ„äº‹é¡¹

1. **é‚®ç®±æ ¼å¼**: ç³»ç»Ÿä½¿ç”¨æ ‡å‡†çš„é‚®ç®±æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒéªŒè¯
2. **ç”¨æˆ·IDç”Ÿæˆ**: åŸºäºé‚®ç®±çš„SHA-256å“ˆå¸Œï¼Œç¡®ä¿å”¯ä¸€æ€§å’Œä¸€è‡´æ€§
3. **å¯¹è¯éš”ç¦»**: ä¸åŒé‚®ç®±çš„å¯¹è¯å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
4. **å‘åå…¼å®¹**: åŸæœ‰çš„èŠå¤©åŠŸèƒ½ä¿æŒä¸å˜ï¼Œæ–°åŠŸèƒ½ä¸ºå¯é€‰å¢å¼º

## é”™è¯¯å¤„ç†

- æ— æ•ˆé‚®ç®±æ ¼å¼ä¼šè¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯
- å¯¹è¯IDä¸åŒ¹é…ä¼šåˆ›å»ºæ–°å¯¹è¯
- ç½‘ç»œé”™è¯¯å’ŒæœåŠ¡å™¨é”™è¯¯éƒ½æœ‰ç›¸åº”çš„å¼‚å¸¸å¤„ç†

## å®‰å…¨è€ƒè™‘

- é‚®ç®±åœ°å€ç»è¿‡å“ˆå¸Œå¤„ç†ç”Ÿæˆç”¨æˆ·IDï¼Œä¸ç›´æ¥å­˜å‚¨åŸå§‹é‚®ç®±
- å¯¹è¯æ•°æ®ä¸ç”¨æˆ·IDå…³è”ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
- è¾“å…¥éªŒè¯é˜²æ­¢æ³¨å…¥æ”»å‡»